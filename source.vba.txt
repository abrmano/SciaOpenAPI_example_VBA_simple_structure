Option Explicit

Public Sub Calculate()



  Dim SENpath As String
  SENpath = Range("B1").Value
  
  Dim templ As String
  templ = Range("B2").Value
  
  Debug.Print SENpath
  Debug.Print templ
  
  Dim env As SCIA_OpenAPI.Environment
  Set env = New SCIA_OpenAPI.Environment
  
  Call env.Init(SENpath, ".\tmp", "1.0.0.0")


  
  Dim n1id As New ApiGuid
  Call n1id.SetFromString(Get_NewGUID())
  Dim n2id As New ApiGuid
  Call n2id.SetFromString(Get_NewGUID())
  Dim matid As New ApiGuid
  Call matid.SetFromString(Get_NewGUID())
  Dim cssid As New ApiGuid
  Call cssid.SetFromString(Get_NewGUID())
  Dim b1id As New ApiGuid
  Call b1id.SetFromString(Get_NewGUID())
  Dim sup1id As New ApiGuid
  Call sup1id.SetFromString(Get_NewGUID())
  Dim lg1id As New ApiGuid
  Call lg1id.SetFromString(Get_NewGUID())
  Dim lc1id As New ApiGuid
  Call lc1id.SetFromString(Get_NewGUID())
  Dim pf1id As New ApiGuid
  Call pf1id.SetFromString(Get_NewGUID())

  Dim n1 As SCIA_OpenAPI.StructNode
  Set n1 = New SCIA_OpenAPI.StructNode
  Set n1.ID = n1id
  n1.Name = "N1"
  n1.X = 1.5
  n1.Y = -2.3
  n1.Z = 4.5
  
  Dim n2 As New StructNode
  Set n2.ID = n2id
  n2.Name = "N2"
  n2.X = 5.5
  n2.Y = -2.3
  n2.Z = 4.5
    
    
    
  Dim mat As SCIA_OpenAPI.Material
  Set mat = New SCIA_OpenAPI.Material
  Set mat.ID = matid
  mat.Name = "mat"
  mat.Type = 1
  mat.Quality = "C30/37"
  
      
  Dim css As New SCIA_OpenAPI.CrossSectionManufactured
  Set css.ID = cssid
  css.Name = "css"
  css.Profile = "HEA260"
  css.FormCode = 1
  css.DescriptionId = 0
  Set css.Material = matid

  Dim nodes As SCIA_OpenAPI.ApiGuidArr
  Set nodes = New SCIA_OpenAPI.ApiGuidArr
  Call nodes.Init(2)
  Call nodes.SetElementFromGuidString(0, n1id.ReturnString)
  Call nodes.SetElementFromGuidString(1, n2id.ReturnString)
  
  
  Dim b1 As New SCIA_OpenAPI.Beam
  Set b1.ID = b1id
  b1.Name = "beam1"
  Set b1.css = css.ID
  Set b1.nodes = nodes
  
  Dim sup1 As New SCIA_OpenAPI.PointSupport
  Set sup1.ID = sup1id
  sup1.Name = "PS1"
  Set sup1.NodeId = n1id
  
  Dim lg1 As New SCIA_OpenAPI.LoadGroup
  Set lg1.ID = lg1id
  lg1.Name = "LoadGroup1"
  lg1.Type = 0
  
  Dim lc1 As New SCIA_OpenAPI.LoadCase
  Set lc1.ID = lc1id
  lc1.Name = "LoadCase1"
  Set lc1.LoadGroupId = lg1id
  lc1.ActionType = 0
  lc1.LoadCaseType = 1
  
  Dim pf1 As New SCIA_OpenAPI.PointLoadInNode
  Set pf1.ID = pf1id
  pf1.Name = "PF1"
  pf1.Direction = 2
  Set pf1.LoadCaseId = lc1id
  Set pf1.NodeId = n2id
  pf1.Value = -1250
  
  

  
  Call env.RunSCIAEngineer(GuiMode_ShowWindowShow)
  Debug.Print "SEn started"


  Dim proj As EsaProject
  Set proj = env.OpenProject(templ)
  Debug.Print "Template opened"
  

  
  Call proj.Model.CreateNode(n1)
  Call proj.Model.CreateNode(n2)
  Call proj.Model.CreateMaterial(mat)
  Call proj.Model.CreateCrossSection(css)
  Call proj.Model.CreateBeam(b1)
  Call proj.Model.CreatePointSupport(sup1)
  Call proj.Model.CreateLoadGroup(lg1)
  Call proj.Model.CreateLoadCase(lc1)
  Call proj.Model.CreatePointLoadInNode(pf1)

  
  Call proj.Model.RefreshModel_ToSCIAEngineer
  
  Call proj.RunCalculation
  
  Dim rapi As ResultsAPI
  Set rapi = proj.Model.InitializeResultsAPI()
  
  Dim key As New ResultKey
  key.EntityType = eDsElementType_eDsElementType_Beam
  key.EntityName = "beam1"
  key.CaseType = eDsElementType_eDsElementType_LoadCase
  Set key.CaseId = lc1id
  key.Dimension = eDimension_eDim_1D
  key.ResultType = eResultType_eFemBeamInnerForces
  key.CoordSystem = eCoordSystem_eCoordSys_Local
  
  Dim rintf As Result
  Set rintf = rapi.LoadResult(key)
  
  Dim resulttable As String
  resulttable = rintf.GetTextOutput()
  'MsgBox resulttable
  Debug.Print (resulttable)
  
  Dim i As Integer
  Dim pivot As Double
  Dim maxvalue As Double

  i = 0
  pivot = 0
  maxvalue = 0
  expectedvalue = 1

  Do While i < rintf.GetMeshElementCount()
    pivot = rintf.GetValue(4, i)
    If Abs(pivot) > Abs(maxvalue) Then maxvalue = pivot
    i = i + 1
  Loop

  Debug.Print "Maximum bending moment is "
  Debug.Print maxvalue

  Call proj.CloseProject(SaveMode_SaveChangesNo)

  
End Sub

